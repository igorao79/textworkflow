# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ QStash –¥–ª—è cron –∑–∞–¥–∞—á

## üöÄ –ß—Ç–æ —Ç–∞–∫–æ–µ QStash?

QStash - —ç—Ç–æ serverless —Ä–µ—à–µ–Ω–∏–µ –æ—Ç Upstash –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π. –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç node-cron, QStash:

- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –≤ production (serverless, Docker, etc.)
- ‚úÖ –ù–µ —Ç–µ—Ä—è–µ—Ç –∑–∞–¥–∞—á–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ò–º–µ–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –∑–∞—â–∏—Ç—É –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

## üìã –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ Upstash

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ [https://console.upstash.com](https://console.upstash.com)
2. –°–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –∏–ª–∏ –≤–æ–π–¥–∏—Ç–µ
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª **QStash**

### 2. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

1. –í QStash dashboard –Ω–∞–∂–º–∏—Ç–µ **"Create Token"**
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ **QSTASH_TOKEN**
3. –°–æ–∑–¥–∞–π—Ç–µ **Signing Keys** –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ webhook:
   - –ù–∞–∂–º–∏—Ç–µ **"Create Signing Key"**
   - –°–∫–æ–ø–∏—Ä—É–π—Ç–µ **Current Signing Key** –∏ **Next Signing Key**

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ –≤–∞—à `.env` —Ñ–∞–π–ª:

```bash
# QStash Configuration (—Ç–æ–ª—å–∫–æ –¥–ª—è production)
QSTASH_TOKEN=your_qstash_token_here
QSTASH_CURRENT_SIGNING_KEY=your_current_signing_key
QSTASH_NEXT_SIGNING_KEY=your_next_signing_key

# URL –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è QStash)
NEXT_PUBLIC_APP_URL=https://your-domain.com

# –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok
# NEXT_PUBLIC_APP_URL=https://your-ngrok-url.ngrok.io
```

#### –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

–í development —Ä–µ–∂–∏–º–µ QStash –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π node-cron –∫–∞–∫ fallback. –í–∞–º –Ω–µ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å QStash –ª–æ–∫–∞–ª—å–Ω–æ!

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å QStash –ª–æ–∫–∞–ª—å–Ω–æ:
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ [ngrok](https://ngrok.com/)
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: `ngrok http 3000`
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ HTTPS URL –æ—Ç ngrok
4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ –∫–∞–∫ `NEXT_PUBLIC_APP_URL`
5. –î–æ–±–∞–≤—å—Ç–µ QStash —Ç–æ–∫–µ–Ω—ã –≤ `.env`

### 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

#### –í Development —Ä–µ–∂–∏–º–µ (–ª–æ–∫–∞–ª—å–Ω–æ):
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: `npm run dev`
2. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ cron –∑–∞–¥–∞—á—É –≤ dashboard
3. **QStash –æ—Ç–∫–ª—é—á–µ–Ω** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è node-cron fallback
4. Workflow –¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
5. –í –ª–æ–≥–∞—Ö —É–≤–∏–¥–∏—Ç–µ: `üß™ Development mode: QStash disabled, using node-cron fallback`

#### –í Production —Ä–µ–∂–∏–º–µ (—Å QStash):
1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `NEXT_PUBLIC_APP_URL` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –≤–∞—à domain
2. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ cron –∑–∞–¥–∞—á—É –≤ dashboard
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ - –¥–æ–ª–∂–Ω–∞ —Å–æ–∑–¥–∞—Ç—å—Å—è QStash schedule
4. –ß–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É webhook –æ—Ç QStash –≤—ã–ø–æ–ª–Ω–∏—Ç workflow

#### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å ngrok (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ ngrok
npm install -g ngrok

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ tunnel
ngrok http 3000

# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ HTTPS URL –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ .env
NEXT_PUBLIC_APP_URL=https://abc123.ngrok.io
```

## üîß API Endpoints

### –°–æ–∑–¥–∞–Ω–∏–µ cron –∑–∞–¥–∞—á–∏
```
POST /api/cron/activate/{workflowId}
```
–°–æ–∑–¥–∞–µ—Ç QStash schedule –¥–ª—è workflow.

### –û—Å—Ç–∞–Ω–æ–≤–∫–∞ cron –∑–∞–¥–∞—á–∏
```
DELETE /api/cron/deactivate/{workflowId}
```
–£–¥–∞–ª—è–µ—Ç QStash schedule.

### –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á
```
GET /api/cron
```
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö QStash schedules.

### Webhook endpoint
```
POST /api/qstash/webhook
```
–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç webhook –æ—Ç QStash –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç workflow.

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–π endpoint
```
GET /api/test-cron
```
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å QStash schedules.

### –†—É—á–Ω–æ–π —Ç—Ä–∏–≥–≥–µ—Ä
```
POST /api/test-cron?workflowId={id}&action=trigger
```
–ó–∞–ø—É—Å–∫–∞–µ—Ç workflow –≤—Ä—É—á–Ω—É—é –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **URL –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `NEXT_PUBLIC_APP_URL` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –≤–∞—à production domain
2. **Signing Keys**: –û–±–Ω–æ–≤–ª—è–π—Ç–µ –∏—Ö —Ä–µ–≥—É–ª—è—Ä–Ω–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
3. **Billing**: QStash –∏–º–µ–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π tier, –Ω–æ –ø–ª–∞—Ç–∏—Ç –∑–∞ executions
4. **Timezone**: QStash —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ UTC, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤—Ä–µ–º—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è —Å node-cron

–ï—Å–ª–∏ —É –≤–∞—Å –±—ã–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ node-cron –∑–∞–¥–∞—á–∏:

1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏—Ö —á–µ—Ä–µ–∑ UI
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å QStash
3. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ cron –∑–∞–¥–∞—á–∏ –∑–∞–Ω–æ–≤–æ

Node-cron –∑–∞–¥–∞—á–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ.

## üö® Troubleshooting

### "invalid destination url: endpoint resolves to a loopback address"
- **–ü—Ä–∏—á–∏–Ω–∞:** QStash –Ω–µ –º–æ–∂–µ—Ç –¥–æ—Å—Ç–∏—á—å localhost
- **–†–µ—à–µ–Ω–∏–µ:** –í development —Ä–µ–∂–∏–º–µ QStash –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è
- **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è QStash –ª–æ–∫–∞–ª—å–Ω–æ

### Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `NEXT_PUBLIC_APP_URL` (–Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å localhost)
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ QStash dashboard
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ webhook endpoint –¥–æ—Å—Ç—É–ø–µ–Ω: `https://yourdomain.com/api/qstash/webhook`

### Signature verification fails
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ signing keys –≤ .env —Ñ–∞–π–ª–µ
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ (–æ–±–Ω–æ–≤–∏—Ç–µ –≤ QStash console)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `upstash-signature` header –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è

### Schedule –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `QSTASH_TOKEN`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ cron –≤—ã—Ä–∞–∂–µ–Ω–∏–µ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `NEXT_PUBLIC_APP_URL`

### Development mode –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `NODE_ENV=development` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ `npm run dev`)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ `üß™ Development mode: QStash disabled`

### Production –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ dev —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Å–µ QStash –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `NEXT_PUBLIC_APP_URL` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ production domain
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ webhook endpoint –¥–æ—Å—Ç—É–ø–µ–Ω –ø—É–±–ª–∏—á–Ω–æ

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [QStash Docs](https://docs.upstash.com/qstash)
- [QStash SDK](https://github.com/upstash/qstash-js)
- [Upstash Console](https://console.upstash.com)
